{"version":3,"sources":["../src/datasource.js"],"names":["GenericDatasource","instanceSettings","$q","backendSrv","templateSrv","type","url","name","q","withCredentials","headers","basicAuth","length","datasourceRequest","method","then","response","status","message","title","options","query","filterPlaceholders","targets","_","filter","target","hide","when","entries","Array","apply","map","datapoints","parent","apiEndpoint","senmlValues","float","string","bool","recursiveReq","idi","senmlValue","datatypes","metric","senmlFields","value","time","range","from","toISOString","to","data","d","nextlink","nextLink","convertData","push","entry","metrics","recursiveMetricReq","page","res","total","convertMetrics","console","log","streams","i","datatype","dataType","text"],"mappings":"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","file":"datasource.js","sourcesContent":["import _ from \"lodash\";\r\n\r\nexport class GenericDatasource {\r\n\r\n  constructor(instanceSettings, $q, backendSrv, templateSrv) {\r\n    this.type = instanceSettings.type;\r\n    this.url = instanceSettings.url;\r\n    this.name = instanceSettings.name;\r\n    this.q = $q;\r\n    this.backendSrv = backendSrv;\r\n    this.templateSrv = templateSrv;\r\n    this.withCredentials = instanceSettings.withCredentials;\r\n    this.headers = {'Content-Type': 'application/json'};\r\n    if (typeof instanceSettings.basicAuth === 'string' && instanceSettings.basicAuth.length > 0) {\r\n      this.headers['Authorization'] = instanceSettings.basicAuth;\r\n    }\r\n  }\r\n\r\n  // Required\r\n  // Used for testing datasource in datasource configuration page\r\n  testDatasource() {\r\n    return this.backendSrv.datasourceRequest({\r\n      url: this.url + '/health',\r\n      method: 'GET'\r\n    }).then(response => {\r\n      if (response.status === 200) {\r\n        return {status: \"success\", message: \"Data source is working\", title: \"Success\"};\r\n      }\r\n    });\r\n  }\r\n\r\n  // Query data from Data API\r\n  // Called once per panel (graph)\r\n  query(options) {\r\n    var query = this.filterPlaceholders(options);\r\n    //console.log(\"query QUERY:\", JSON.stringify(query));\r\n\r\n    // Filter targets that are set to hidden\r\n    query.targets = _.filter(query.targets, target => {\r\n      return target.hide != true;\r\n    });\r\n\r\n    // All targets filtered OR no metric selected\r\n    if (query.targets.length <= 0 || !('metric' in query.targets[0])) {\r\n      return this.q.when([]);\r\n    }\r\n \r\n    // Make a new array with zero-valued object fields\r\n    var entries = Array.apply(null, Array(query.targets.length)).map(function () {\r\n      return {target: '', datapoints: []};\r\n    });\r\n\r\n    var parent = this;\r\n\r\n    const apiEndpoint = \"data/\";\r\n    const senmlValues = {float: \"v\", string: \"sv\", bool: \"bv\"}\r\n    // Recursively query all pages of every target\r\n    function recursiveReq(idi,url) {\r\n\r\n      var target = query.targets[idi];\r\n      var senmlValue = senmlValues[target.datatypes[target.metric]];\r\n      var senmlFields = {value: senmlValue, time: \"t\"};\r\n\r\n      if (url == \"\"){\r\n        url = parent.url + \"/\" + apiEndpoint + target.metric +\r\n        '?from=' + query.range.from.toISOString() + '&to=' + query.range.to.toISOString()\r\n      }else{\r\n        url = parent.url + url\r\n      }\r\n      return parent.backendSrv.datasourceRequest({\r\n        url: url ,\r\n        data: query,\r\n        method: 'GET'\r\n      }).then(function (d) {\r\n        var nextlink = d.data.nextLink; \r\n        var datapoints = parent.convertData(d.data, senmlFields);\r\n     \r\n        entries[idi].target = target.metric \r\n        entries[idi].datapoints.push(...datapoints);\r\n\r\n        if (nextlink != \"\") {\r\n          // query the next page\r\n          return recursiveReq( idi,nextlink);\r\n        } else if (idi < query.targets.length - 1) {\r\n          // one target done, query the next target\r\n          return recursiveReq(++idi,\"\");\r\n        } else {\r\n          // all done\r\n          d.data = entries;\r\n          return d;\r\n        }\r\n\r\n      });\r\n    } // end func\r\n   \r\n    return recursiveReq(0,\"\");\r\n  }\r\n\r\n  // Convert historical SenML data from Data/Aggr API to Grafana datapoints\r\n  convertData(data, senmlFields) {\r\n    /*var datapoints = Array(data.data.length);\r\n    for (var i = 0; i < data.data.length; i++) {\r\n      datapoints[i] = [data.data[i][senmlFields.value], data.data[i][senmlFields.time] * 1000];\r\n    }*/\r\n    var datapoints = _.map(data.data, entry => {\r\n      return [entry[senmlFields.value], entry[senmlFields.time] * 1000];\r\n    });\r\n    return datapoints;\r\n  }\r\n\r\n  // Remove targets that have unselected metric or source\r\n  filterPlaceholders(options) {\r\n    options.targets = _.filter(options.targets, target => {\r\n      return target.metric !== 'select metric';\r\n    });\r\n\r\n    return options;\r\n  }\r\n\r\n  // Query list of metrics from Registry API\r\n  // Required for templating\r\n  queryMetrics(options) {\r\n    var metrics = []\r\n    var parent = this;\r\n    function recursiveMetricReq(page) {\r\n      return parent.backendSrv.datasourceRequest({\r\n        //url: this.url + '/search',\r\n        url: parent.url + '/registry?page='+page,\r\n        data: options,\r\n        method: 'GET',\r\n        //headers: { 'Content-Type': 'application/json' }\r\n      }).then(function (res) {\r\n        var total = res.data.total; // total from data api\r\n        metrics.push(...parent.convertMetrics(res));\r\n        if (total > metrics.length) {\r\n          // query the next page\r\n          return recursiveMetricReq(++page);\r\n        } else {\r\n          console.log( total);\r\n          console.log( metrics.length);\r\n          //metrics.forEach(function(entry) {\r\n          //  console.log(entry.text);\r\n          //});\r\n          return metrics;\r\n        }\r\n\r\n      });\r\n    }\r\n    return recursiveMetricReq(1);\r\n  }\r\n\r\n  // Convert registration from Registry API to the format required by Grafana + some meta information\r\n  convertMetrics(res) {\r\n    return _.map(res.data.streams, (d, i) => {\r\n      return {\r\n        datatype: d.dataType,\r\n        text: d.name,\r\n        value: i\r\n      };\r\n    });\r\n  }\r\n\r\n\r\n}\r\n"]}